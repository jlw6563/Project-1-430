<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Our simple HTTP server</title>
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <script>
      //Handles responses that are returned
      const handleResponse = async (response, method) => {
        const content = document.querySelector("#content");

        //Responds based on the status code
        switch (response.status) {
          case 200:
            content.innerHTML = `<b>Success</b>`;
            break;
          case 201:
            content.innerHTML = "<b>Created</b>";
            break;
          case 204:
            content.innerHTML = "<b>Updated (No Content)</b>";
            return;
          case 400:
            content.innerHTML = `<b>Bad Request</b>`;
            break;
          case 404:
            content.innerHTML = `<b>Not Found</b>`;
            break;
          default:
            content.innerHTML = `Error code not implemented by client.`;
            break;
        }

        //If for post, get, or head
        if (method === "post") {
          let obj = await response.json();
          content.innerHTML += `<p>${obj.message}</p>`;
        } else if (method === "get") {
          let obj = await response.json();
          let jsonString = JSON.stringify(obj);
          content.innerHTML += `<p>${jsonString}</p>`;
        } else {
          content.innerHTML += "<p>Meta Data Received</p>";
        }
      };

      //Sends a post request by taking the form
      const sendPost = async (nameForm) => {
        //Turns the form into a FormData object
        //Then into JSONFormat that can be sent to parse body
        const FORM_DATA = new FormData(nameForm);
        const JSON_DATA = new URLSearchParams(FORM_DATA);

        //Gets the URL from the action
        //Then sets the proper data fields
        const response = await fetch(nameForm.getAttribute("action"), {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Accept: "application/json",
          },
          body: JSON_DATA,
        });

        //Handles the result
        handleResponse(response, "post");
      };

      //Sends a get request using the name form
      const sendGet = async (nameForm) => {
        //Gets the method for head or get
        //Gets the url using the action of the form
        //Gets all query params for the form based on the class
        const method = nameForm.querySelector("#methodSelect").value;
        let url = nameForm.getAttribute("action");
        let queryParams = nameForm.querySelectorAll(".queryParam");

        //For figuring out if this is the first query param
        let firstQueryParam = false;

        //Goes through the list of query params
        queryParams.forEach((param) => {
          let paramFormatted = param.value.toLowerCase().trim();

          //First checks if the param is empty
          if (paramFormatted !== "") {
            //If this is the first param
            if (firstQueryParam === false) {
              //Sets it to true so all other params go second/through the else
              firstQueryParam = true;
              url += `?${param.name}=${paramFormatted}`;
            } else {
              url += `&${param.name}=${paramFormatted}`;
            }
          }
        });

        console.log(url);

        let response = await fetch(url, {
          method,
          headers: {
            Accept: "application/json",
          },
        });

        handleResponse(response, method);
      };

      const init = () => {
        const Forms = [
          document.querySelector("#addPokemon"),
          document.querySelector("#caughtPokemon"),
          document.querySelector("#allCaught"),
          document.querySelector("#allNames"),
          document.querySelector("#allTypes"),
          document.querySelector("#allPokemon"),
        ];

        Forms.forEach((form) => {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            if (form.getAttribute("method") === "post") sendPost(form);
            else sendGet(form);
            return false;
          });
        });
      };

      window.onload = init;
    </script>
  </head>
  <body>
    <section id="top">
      <h3>Pokedex</h3>
      <form id="addPokemon" action="/AddPokemon" method="post">
        <label for="num">Num: </label>
        <input id="numField" type="number" name="num" min="0" step="1" />
        <label for="name">Name: </label>
        <input id="nameField" type="text" name="name" />

        <label for="height">Height: </label>
        <input id="heightField" type="number" name="height" min="0" step="1" />
        <label for="weight">Weight: </label>
        <input id="weightField" type="number" name="weight" min="0" step="1" />
        <input type="submit" value="Add Pokemon" />
      </form>
      <form id="caughtPokemon" action="/Caught" method="post">
        <label for="caught">Pokemon Name: </label>
        <input id="caughtField" type="text" name="caught" />
        <input type="submit" value="Mark Caught" />
      </form>

      <form id="allNames" action="/PokemonNames" method="get">
        <label for="methodSelect">Get All Pokemon Names</label>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Get Pokemon Names" />
      </form>

      <form id="allTypes" action="/PokemonTypes" method="get">
        <label for="methodSelect">Get All Pokemon's type</label>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <label for="">Type Select:</label>
        <input type="text" name="type" class="queryParam" />
        <input type="submit" value="Get Pokemon Types" />
      </form>

      <form id="allPokemon" action="/AllPokemon" method="get">
        <label for="methodSelect">Get All Data About Pokemon</label>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Get Pokemon Data" />
      </form>
      <form id="allCaught" action="/AllCaught" method="get">
        <label for="methodSelect">Get All Caught Pokemon</label>
        <select id="methodSelect">
          <option value="get">GET</option>
          <option value="head">HEAD</option>
        </select>
        <input type="submit" value="Get Pokemon Caught" />
      </form>
    </section>
    <section id="content"></section>
  </body>
</html>
